<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add New Game</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 20px;
      color: #333;
    }

    .form-container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    h1 {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 30px;
      font-weight: 300;
      letter-spacing: 1px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #2c3e50;
    }

    input[type="text"],
    textarea,
    select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
      transition: border-color 0.3s;
      box-sizing: border-box;
    }

    input[type="text"]:focus,
    textarea:focus,
    select:focus {
      border-color: #3498db;
      outline: none;
      box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
    }

    textarea {
      min-height: 120px;
      resize: vertical;
    }

    .rating-container {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .star-rating {
      display: flex;
      gap: 5px;
    }

    .star-rating input[type="radio"] {
      display: none;
    }

    .star-rating label {
      font-size: 24px;
      color: #ddd;
      cursor: pointer;
      transition: color 0.2s;
    }

    .star-rating label:hover,
    .star-rating label:hover ~ label {
      color: #f39c12;
    }

    .star-rating input[type="radio"]:checked ~ label,
    .star-rating input[type="radio"]:checked + label {
      color: #f39c12;
    }

    .strike-container {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .strike-checkbox {
      display: none;
    }

    .strike-label {
      font-size: 24px;
      color: #ddd;
      cursor: pointer;
      width: 30px;
      text-align: center;
      transition: color 0.2s;
    }

    .strike-checkbox:checked + .strike-label {
      color: #e74c3c;
    }

    .radio-group {
      display: flex;
      gap: 15px;
    }

    .radio-option {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .file-upload {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .file-upload-preview {
      width: 200px;
      height: 280px;
      border: 2px dashed #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      border-radius: 8px;
    }

    .file-upload-preview img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .image-upload-container {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }

    .image-upload-box {
      flex: 1;
      min-width: 250px;
    }

    .submit-btn {
      background-color: #2ecc71;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
      width: 100%;
      margin-top: 20px;
    }

    .submit-btn:hover {
      background-color: #27ae60;
    }

    .cancel-btn {
      background-color: #e74c3c;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
      width: 100%;
      margin-top: 10px;
    }

    .cancel-btn:hover {
      background-color: #c0392b;
    }
		
	.category-management {
	  display: flex;
	  flex-direction: column;
	  gap: 8px;
	}

	.category-controls {
	  display: flex;
	  gap: 8px;
	}

	.category-controls input {
	  flex-grow: 1;
	}

	.category-controls button {
	  padding: 5px 10px;
	  cursor: pointer;
	}

    /* Ensure inputs are always interactive */
    input, textarea, select {
      pointer-events: auto !important;
      user-select: text !important;
    }
  </style>
</head>
<body>
<div class="form-container">
  <h1>Add New Game</h1>
  <form id="gameForm" enctype="multipart/form-data">
    <div class="form-group">
      <label for="title">Game Title</label>
      <input type="text" id="title" name="title" required placeholder="Enter game title" tabindex="1">
    </div>

    <div class="form-group">
      <label for="link">Game Link</label>
      <input type="text" id="link" name="link" placeholder="Enter store/page URL" tabindex="2">
    </div>

    <div class="form-group">
      <label>Rage Rating</label>
      <div class="rating-container">
        <div class="star-rating">
          <input type="radio" id="star0" name="rageRating" value="0" checked>
          <input type="radio" id="star1" name="rageRating" value="1" tabindex="3">
          <label for="star1">★</label>
          <input type="radio" id="star2" name="rageRating" value="2" tabindex="4">
          <label for="star2">★</label>
          <input type="radio" id="star3" name="rageRating" value="3" tabindex="5">
          <label for="star3">★</label>
        </div>
        <span id="rating-value">0/3</span>
      </div>
    </div>

    <div class="form-group">
      <label>Finished</label>
      <div class="radio-group">
        <div class="radio-option">
          <input type="radio" id="finished-yes" name="finished" value="true" tabindex="6">
          <label for="finished-yes">Yes</label>
        </div>
        <div class="radio-option">
          <input type="radio" id="finished-no" name="finished" value="false" checked tabindex="7">
          <label for="finished-no">No</label>
        </div>
      </div>
    </div>
	
	<div class="form-group">
	  <label>Checked?</label>
	  <div class="radio-group">
		<div class="radio-option">
		  <input type="radio" id="is_checked-yes" name="is_checked" value="true" checked tabindex="6">
		  <label for="is_checked-yes">Yes</label>
		</div>
		<div class="radio-option">
		  <input type="radio" id="is_checked-no" name="is_checked" value="false" tabindex="7">
		  <label for="is_checked-no">No</label>
		</div>
	  </div>
	</div>

	<div class="form-group">
	  <label for="platform">Genre</label>
	  <div class="category-management">
		<select id="platform" name="platform" tabindex="16">
                    <option value="">Select category...</option>
					  <option value="Amiga">Amiga</option>
					  <option value="Atari">Atari</option>
					  <option value="Commodore-64">Commodore-64</option>
					  <option value="DOS">DOS</option>
					  <option value="Windows">Windows</option>
		</select>
		<div class="category-controls">
		  <input type="text" id="new-category" placeholder="New category name">
		  <button type="button" id="add-category">Add</button>
		  <button type="button" id="delete-category">Delete Selected</button>
		</div>
	  </div>
	</div>

    <div class="form-group">
      <label>Three Strikes</label>
      <div class="strike-container">
        <input type="checkbox" id="strike1" name="strikeValues" value="1" class="strike-checkbox" tabindex="9">
        <label for="strike1" class="strike-label">X</label>

        <input type="checkbox" id="strike2" name="strikeValues" value="2" class="strike-checkbox" tabindex="10">
        <label for="strike2" class="strike-label">X</label>

        <input type="checkbox" id="strike3" name="strikeValues" value="3" class="strike-checkbox" tabindex="11">
        <label for="strike3" class="strike-label">X</label>

        <input type="hidden" name="strikes" id="strikesCount" value="0">
      </div>
    </div>

    <div class="form-group">
      <label>Game Images</label>
      <div class="image-upload-container">
        <div class="image-upload-box">
          <label>Cover Art</label>
          <div class="file-upload">
            <input type="file" id="coverArt" name="coverArt" accept="image/*" tabindex="12">
            <div class="file-upload-preview" id="coverPreview">
              <span>No image selected</span>
            </div>
          </div>
        </div>
        <div class="image-upload-box">
          <label>Gameplay Image</label>
          <div class="file-upload">
            <input type="file" id="gameplayImage" name="gameplayImage" accept="image/*" tabindex="13">
            <div class="file-upload-preview" id="gameplayPreview">
              <span>No image selected</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="form-group">
      <label for="notes">Notes</label>
      <textarea id="notes" name="notes" placeholder="Enter any additional notes about the game" tabindex="14"></textarea>
    </div>

    <button type="submit" class="submit-btn" tabindex="15">Add Game</button>
    <button type="button" class="cancel-btn" onclick="window.location.href='game-collection.html'" tabindex="16">Cancel</button>
  </form>
</div>

<script>
    
		document.addEventListener('DOMContentLoaded', function() {
	  const platformSelect = document.getElementById('platform');
	  const newCategoryInput = document.getElementById('new-category');
	  const addButton = document.getElementById('add-category');
	  const deleteButton = document.getElementById('delete-category');

	  // Add new category
	  addButton.addEventListener('click', function() {
		const newCategory = newCategoryInput.value.trim();
		if (newCategory && !categoryExists(newCategory)) {
		  const option = document.createElement('option');
		  option.value = newCategory;
		  option.textContent = newCategory;
		  platformSelect.appendChild(option);
		  newCategoryInput.value = '';
		}
	  });

	  // Delete selected category
	  deleteButton.addEventListener('click', function() {
		if (platformSelect.selectedIndex > 0) { // Don't delete the "Select category..." option
		  platformSelect.remove(platformSelect.selectedIndex);
		}
	  });

	  // Check if category already exists
	  function categoryExists(category) {
		return Array.from(platformSelect.options).some(
		  option => option.value.toLowerCase() === category.toLowerCase()
		);
	  }

	  // Allow adding by pressing Enter
	  newCategoryInput.addEventListener('keypress', function(e) {
		if (e.key === 'Enter') {
		  addButton.click();
		}
	  });
	});
	
	// Initialize form when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        initializeForm();
    });

    // Also initialize on window load as backup
    window.addEventListener('load', function() {
        setTimeout(initializeForm, 100);
    });

    function initializeForm() {
        // Force focus on the first input field
        const titleInput = document.getElementById('title');
        if (titleInput) {
            titleInput.focus();
            titleInput.click(); // Additional trigger to ensure focus
        }

        // Reset form to ensure clean state
        document.getElementById('gameForm').reset();
        
        // Reset previews
        document.getElementById('coverPreview').innerHTML = '<span>No image selected</span>';
        document.getElementById('gameplayPreview').innerHTML = '<span>No image selected</span>';
        
        // Reset rating display
        document.getElementById('rating-value').textContent = '0/3';
        document.getElementById('strikesCount').value = '0';

        // Re-enable all form elements
        const allInputs = document.querySelectorAll('input, textarea, select, button');
        allInputs.forEach(element => {
            element.disabled = false;
            element.style.pointerEvents = 'auto';
        });

        console.log('Form initialized and focused');
    }

    document.getElementById('gameForm').addEventListener('submit', submitForm);

    async function submitForm(event) {
        event.preventDefault();
        
        // Disable form during submission to prevent double-submit
        const submitBtn = document.querySelector('.submit-btn');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Adding Game...';
        
        const formData = new FormData(document.getElementById('gameForm'));
        
        // Calculate strikes count
        const strikeCheckboxes = document.querySelectorAll('input[name="strikeValues"]:checked');
        formData.set('strikes', strikeCheckboxes.length.toString());
        
        try {
            const response = await fetch('http://localhost:3000/games/create', {
                method: 'POST',
                body: formData
            });
            
            if (response.ok) {
                const result = await response.json();
                alert('Game created successfully');
                window.location.href = 'game-collection.html';
            } else {
                const error = await response.json();
                throw new Error(error.error || 'Failed to create game');
            }
        } catch (error) {
            console.error('Error creating game:', error);
            alert('Error creating game: ' + error.message);
            
            // Re-enable form on error
            submitBtn.disabled = false;
            submitBtn.textContent = 'Add Game';
        }
    }

    // Star rating interaction
    const starInputs = document.querySelectorAll('.star-rating input[type="radio"]');
    const ratingValue = document.getElementById('rating-value');

    starInputs.forEach(input => {
        input.addEventListener('change', () => {
            const value = input.value;
            ratingValue.textContent = `${value}/3`;
            
            // Update star colors
            const starLabels = document.querySelectorAll('.star-rating label');
            starLabels.forEach((label, index) => {
                label.style.color = (index + 1) <= value ? '#f39c12' : '#ddd';
            });
        });
    });

    // Strike checkboxes interaction
    const strikeCheckboxes = document.querySelectorAll('.strike-checkbox');
    const strikesCountInput = document.getElementById('strikesCount');
    
    strikeCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', () => {
            const checkedCount = document.querySelectorAll('.strike-checkbox:checked').length;
            strikesCountInput.value = checkedCount;
        });
    });

    // Cover art preview
    const coverInput = document.getElementById('coverArt');
    const coverPreview = document.getElementById('coverPreview');

    coverInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
                coverPreview.innerHTML = `<img src="${event.target.result}" alt="Cover preview">`;
            };
            reader.readAsDataURL(file);
        } else {
            coverPreview.innerHTML = '<span>No image selected</span>';
        }
    });

    // Gameplay image preview
    const gameplayInput = document.getElementById('gameplayImage');
    const gameplayPreview = document.getElementById('gameplayPreview');

    gameplayInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
                gameplayPreview.innerHTML = `<img src="${event.target.result}" alt="Gameplay preview">`;
            };
            reader.readAsDataURL(file);
        } else {
            gameplayPreview.innerHTML = '<span>No image selected</span>';
        }
    });

    // Debug function to check form state
    function debugFormState() {
        const titleInput = document.getElementById('title');
        console.log('Title input exists:', !!titleInput);
        console.log('Title input disabled:', titleInput?.disabled);
        console.log('Title input focused:', document.activeElement === titleInput);
        console.log('Current active element:', document.activeElement);
    }

    // Add click handler to body to ensure form can receive focus
    document.body.addEventListener('click', function(e) {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
            e.target.focus();
        }
    });
</script>
</body>
</html>